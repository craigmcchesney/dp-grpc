syntax = "proto3";

option java_multiple_files = true;
option java_package = "com.ospreydcs.dp.grpc.v1.query";

import "common.proto";

service DpQueryService {
  rpc queryResponseSingle(QueryRequest) returns (QueryResponse);
  rpc queryResponseStream(QueryRequest) returns (stream QueryResponse);
  rpc queryResponseCursor(stream QueryRequest) returns (stream QueryResponse);
}

message QueryRequest {

  oneof request {
    QuerySpec querySpec = 1;
    CursorRequest cursorOp = 2;
  }

  message QuerySpec {
    Timestamp startTime = 1;
    Timestamp endTime = 2;
    repeated string columnNames = 3;
  }

  message CursorRequest {
    uint32 numBuckets = 1;
  }
}

message QueryResponse {

  ResponseType responseType = 1;
  Timestamp responseTime = 2;

  oneof response {
    QueryReport queryReport = 10;
    RejectDetails queryReject = 11;
  }

  message QueryReport {

    oneof reportContent {
      QueryError queryError = 1;
      QuerySummary querySummary = 2;
      QueryData queryData = 3;
    }

    message QueryError {
      string message = 1;
    }

    message QuerySummary {
      uint32 numBuckets = 1;
    }

    message QueryData {
      repeated DataBucket dataBuckets = 1;
      message DataBucket {
        FixedIntervalTimestampSpec samplingInterval = 1;
        repeated Attribute attributes = 2;
        EventMetadata eventMetadata = 3;
        DataColumn dataColumn = 4;
      }
    }
  }
}

